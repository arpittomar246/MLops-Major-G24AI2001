<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Olivetti Face Classifier</title>

  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- custom css -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">Olivetti Classifier</a>
      <div class="ms-auto text-white small">
        Model path: <code>{{ model_info.model_path }}</code>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row g-4">
      <!-- left column: Upload & results -->
      <div class="col-md-7">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Upload Image</h5>
            <p class="card-text text-muted">Upload a face image (jpg/png) — it will be resized to 64×64 grayscale to match the Olivetti dataset preprocessing.</p>

            <form id="upload-form">
              <div class="mb-3">
                <input class="form-control" type="file" id="image-input" accept="image/*">
              </div>

              <div id="preview-area" class="mb-3" style="display:none;">
                <label class="form-label">Preview</label>
                <div><img id="preview-image" src="#" alt="preview" class="img-thumbnail" style="max-width:240px;"></div>
              </div>

              <div class="d-flex gap-2">
                <button id="predict-btn" type="button" class="btn btn-primary">Predict</button>
                <button id="clear-btn" type="button" class="btn btn-outline-secondary">Clear</button>
              </div>
            </form>

            <div id="spinner-area" class="mt-3" style="display:none;">
              <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
              <span class="ms-2">Running model...</span>
            </div>

            <!-- RESULT CARD -->
            <div id="result-area" class="mt-3" style="display:none;">
              <div class="card border-success">
                <div class="card-body">
                  <h6 class="card-subtitle mb-2 text-muted">Prediction</h6>

                  <!-- Friendly predicted label -->
                  <p id="predicted-class" class="h4 mb-1"></p>

                  <!-- Confidence bar for top 1 -->
                  <div id="top1-confidence" class="mb-3" style="display:none;">
                    <div class="small text-muted">Confidence (how sure the model is):</div>
                    <div class="progress" style="height:18px;">
                      <div id="top1-progress" class="progress-bar bg-success" role="progressbar" style="width:0%">0%</div>
                    </div>
                  </div>

                  <!-- Representative sample image placeholder (optional backend support) -->
                  <div id="rep-image-area" style="display:none;" class="mt-3 mb-2">
                    <small class="text-muted">Representative sample from test set (shows an example face with the same label)</small>
                    <div class="mt-2 d-flex gap-3 align-items-center">
                      <img id="rep-image" src="" alt="Representative" class="img-thumbnail" style="width:90px;height:90px;object-fit:cover;">
                      <div><small class="text-muted">True label: <span id="rep-true-label"></span></small></div>
                    </div>
                  </div>

                  <!-- Top-3 predictions list -->
                  <div id="topk-list" class="mt-2"></div>

                </div>
              </div>
            </div>

            <!-- EXPLANATION FOR NON-TECH USERS -->
            <div id="explain-area" class="mt-3" style="display:none;">
              <div class="card bg-light border-secondary">
                <div class="card-body">
                  <h6 class="card-title">What this result means (simple)</h6>
                  <ul class="small mb-2">
                    <li><strong>Class numbers (e.g. "Class 18")</strong> are internal person IDs from the Olivetti dataset (0–39). They represent different people in the dataset.</li>
                    <li><strong>Predicted label</strong> is the model's best guess which person the image belongs to (e.g. "Person 18").</li>
                    <li><strong>Confidence</strong> (percentage) shows how certain the model is. For Decision Trees this can be 100% if a decision leaf contained only that class in training.</li>
                    <li><strong>Top-3</strong> are the next best guesses — they help you see alternatives the model considered.</li>
                  </ul>

                  <div class="small text-muted">
                    <strong>Important:</strong> a high confidence value does not guarantee the model is correct. Models can be overconfident. To verify results, try:
                    <ol>
                      <li>Uploading other images of the same person (if available).</li>
                      <li>Trying the sample images on the <a href="/samples">Samples page</a>.</li>
                      <li>Using more advanced models (Random Forest, CNN) for better real-world performance.</li>
                    </ol>
                  </div>
                </div>
              </div>
            </div>

            <div id="error-area" class="mt-3" style="display:none;">
              <div class="alert alert-danger" role="alert" id="error-text"></div>
            </div>

          </div>
        </div>
      </div>

      <!-- right column: Model info & instructions -->
      <div class="col-md-5">
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h6 class="card-title">Model info</h6>
            <ul class="list-unstyled">
              <li><strong>Model file:</strong> <code>{{ model_info.model_path }}</code></li>
              <li><strong>Test accuracy:</strong> {{ model_info.test_accuracy if model_info.test_accuracy is not none else "Not available" }}</li>
              <li><strong>Number of classes:</strong> {{ model_info.n_classes if model_info.n_classes is not none else "?" }}</li>
              <li><strong>Supports probabilities:</strong> {{ "Yes" if model_info.has_proba else "No" }}</li>
            </ul>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">How to use</h6>
            <ol>
              <li>Click <strong>Choose file</strong> and pick an image (face preferred).</li>
              <li>Preview appears — click <strong>Predict</strong>.</li>
              <li>Top predictions and probabilities will show.</li>
            </ol>
            <p class="small text-muted mb-0">If you see "Model not available", run <code>python train.py</code> to create <code>models/savedmodel.pth</code>.</p>
          </div>
        </div>

      </div>
    </div>

    <footer class="mt-4 text-muted small">
      <div class="d-flex justify-content-between align-items-center">
        <div>Built for ML Ops Major Assignment</div>
        <div>Tip: try uploading a face from the Olivetti dataset for best results</div>
      </div>
    </footer>
  </div>

  <!-- Bootstrap JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Client-side logic -->
  <script>
    const imageInput = document.getElementById('image-input');
    const previewArea = document.getElementById('preview-area');
    const previewImage = document.getElementById('preview-image');
    const predictBtn = document.getElementById('predict-btn');
    const clearBtn = document.getElementById('clear-btn');
    const spinnerArea = document.getElementById('spinner-area');
    const resultArea = document.getElementById('result-area');
    const predictedClassEl = document.getElementById('predicted-class');
    const topkList = document.getElementById('topk-list');
    const errorArea = document.getElementById('error-area');
    const errorText = document.getElementById('error-text');
    const explainArea = document.getElementById('explain-area');
    const top1Confidence = document.getElementById('top1-confidence');
    const top1Progress = document.getElementById('top1-progress');
    const repImageArea = document.getElementById('rep-image-area');
    const repImage = document.getElementById('rep-image');
    const repTrueLabel = document.getElementById('rep-true-label');

    // auto-fill from /samples
    const urlParams = new URLSearchParams(window.location.search);
    const autoImage = urlParams.get("autofill");
    if (autoImage) {
        const imgSrc = "data:image/png;base64," + autoImage;
        previewImage.src = imgSrc;
        previewArea.style.display = 'block';
        fetch(imgSrc).then(res => res.blob()).then(blob => {
            const file = new File([blob], "sample.png", { type: "image/png" });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            imageInput.files = dataTransfer.files;
        });
    }

    // show preview when user selects a file
    imageInput.addEventListener('change', (ev) => {
      const f = ev.target.files[0];
      if (!f) {
        previewArea.style.display = 'none';
        return;
      }
      const url = URL.createObjectURL(f);
      previewImage.src = url;
      previewArea.style.display = 'block';
      // clear previous results
      resultArea.style.display = 'none';
      errorArea.style.display = 'none';
      explainArea.style.display = 'none';
      repImageArea.style.display = 'none';
      top1Confidence.style.display = 'none';
    });

    // clear form
    clearBtn.addEventListener('click', () => {
      imageInput.value = '';
      previewArea.style.display = 'none';
      resultArea.style.display = 'none';
      errorArea.style.display = 'none';
      topkList.innerHTML = '';
      predictedClassEl.textContent = '';
      explainArea.style.display = 'none';
      repImageArea.style.display = 'none';
      top1Confidence.style.display = 'none';
    });

    // predict via AJAX
    predictBtn.addEventListener('click', async () => {
      let f = imageInput.files[0];
      if (!f) {
        errorText.textContent = 'Please choose an image file first.';
        errorArea.style.display = 'block';
        return;
      }

      // prepare form data
      const formData = new FormData();
      formData.append('image', f);

      // UI: show spinner, hide results/errors
      spinnerArea.style.display = 'inline-flex';
      resultArea.style.display = 'none';
      errorArea.style.display = 'none';
      explainArea.style.display = 'none';
      repImageArea.style.display = 'none';
      top1Confidence.style.display = 'none';

      try {
        const resp = await fetch('/predict', {
          method: 'POST',
          body: formData
        });

        spinnerArea.style.display = 'none';

        if (!resp.ok) {
          const body = await resp.json().catch(() => ({}));
          const msg = body.error || `Server returned ${resp.status}`;
          errorText.textContent = msg;
          errorArea.style.display = 'block';
          return;
        }

        const json = await resp.json();

        // friendly predicted label text
        const predictedName = json.predicted_name ? json.predicted_name : `Class ${json.predicted_class}`;
        predictedClassEl.textContent = predictedName;

        // show representative image if backend provides it
        if (json.representative_image_base64) {
          repImage.src = "data:image/png;base64," + json.representative_image_base64;
          repTrueLabel.textContent = json.representative_true_label ?? 'N/A';
          repImageArea.style.display = 'block';
        } else {
          repImageArea.style.display = 'none';
        }

        // show top-3 list with percentages and progress bars (if probabilities available)
        topkList.innerHTML = '';
        if (json.topk && json.topk.length > 0) {
          const container = document.createElement('div');
          container.className = 'list-group';
          json.topk.forEach((p, idx) => {
            // build item header
            const prob = (p.prob !== null && p.prob !== undefined) ? (p.prob * 100) : null;
            const name = p.name ? p.name : `Class ${p.class}`;
            const title = document.createElement('div');
            title.className = 'list-group-item d-flex flex-column';
            const topLine = document.createElement('div');
            topLine.className = 'd-flex justify-content-between mb-2';
            const left = document.createElement('div'); left.textContent = `${name}`;
            const right = document.createElement('div'); right.style.minWidth = '90px';
            right.innerHTML = prob !== null ? `${prob.toFixed(2)}%` : '—';
            topLine.appendChild(left); topLine.appendChild(right);
            title.appendChild(topLine);

            // add a subtle progress bar if prob exists
            if (prob !== null) {
              const progWrap = document.createElement('div');
              progWrap.className = 'progress';
              progWrap.style.height = '10px';
              const prog = document.createElement('div');
              prog.className = 'progress-bar';
              prog.style.width = `${prob}%`;
              prog.setAttribute('aria-valuenow', String(prob));
              prog.setAttribute('aria-valuemin', '0');
              prog.setAttribute('aria-valuemax', '100');
              progWrap.appendChild(prog);
              title.appendChild(progWrap);

              // if this is top-1, also show the larger confidence bar
              if (idx === 0) {
                top1Confidence.style.display = 'block';
                top1Progress.style.width = `${prob}%`;
                top1Progress.textContent = `${prob.toFixed(2)}%`;
              }
            }
            container.appendChild(title);
          });
          topkList.appendChild(container);
        }

        // show explanation card
        explainArea.style.display = 'block';
        resultArea.style.display = 'block';
      } catch (err) {
        spinnerArea.style.display = 'none';
        errorText.textContent = `Client error: ${err.message}`;
        errorArea.style.display = 'block';
      }
    });
  </script>
</body>
</html>
